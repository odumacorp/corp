{% extends '_partials/base.html' %}

{% block content %}
<h2>Conversation with {{ recipient.user.username }}</h2>

<div class="message-thread border p-3 mb-3" style="max-height: 400px; overflow-y: auto;">
  {% for msg in messages %}
    <div class="{% if msg.sender == request.user %}text-end{% endif %}">
      <p><strong>{{ msg.sender.username }}</strong>: {{ msg.content }}</p>
      <small class="text-muted">{{ msg.timestamp|date:"M d, Y H:i" }}</small>
    </div>
    <hr>
  {% endfor %}
</div>

<form method="post">
  {% csrf_token %}
  <div class="mb-3">
    <textarea name="content" rows="3" class="form-control" placeholder="Type your message..."></textarea>
  </div>
  <button type="submit" class="btn btn-primary">Send</button>
</form>

<button class="btn btn-link mt-3" onclick="window.history.back()">‚Üê Go Back</button>
<script>
    const roomName = "{{ room_name }}";
    const socket = new WebSocket(
      'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );
  
    socket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      document.querySelector('#chat-log').innerHTML += ('<p>' + data.message + '</p>');
    };
  
    socket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
    };
  
    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
      if (e.keyCode === 13) {  // Enter key
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        socket.send(JSON.stringify({
          'message': message
        }));
        messageInputDom.value = '';
      }
    };
  </script>
  
{% endblock %}
